<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Plate Detection</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Tesseract.js ‚Äî runs OCR entirely in the browser, no backend needed -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --green: #00ff41; --green-dim: #00cc33; --green-dark: #003b00;
            --bg: #0d0d0d; --card-bg: #0a1a0a; --border: #1a4a1a;
            --text: #c8ffc8; --muted: #5a8a5a;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:var(--bg); color:var(--text); font-family:'Share Tech Mono',monospace; min-height:100vh; overflow-x:hidden; }
        #matrix-bg { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; opacity:0.07; pointer-events:none; }
        .scanline { position:fixed; top:0; left:0; width:100%; height:100%; background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px); pointer-events:none; z-index:9999; }
        .page-wrapper { position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:30px 20px; }
        .back-link { display:inline-flex; align-items:center; gap:8px; color:var(--muted); text-decoration:none; font-size:0.8rem; letter-spacing:1px; margin-bottom:20px; transition:color 0.2s; }
        .back-link:hover { color:var(--green); }
        header { text-align:center; margin-bottom:40px; }
        .title { font-family:'Orbitron',monospace; font-size:clamp(1.5rem,4vw,2.8rem); font-weight:900; color:var(--green); text-shadow:0 0 20px rgba(0,255,65,0.5),0 0 40px rgba(0,255,65,0.2); letter-spacing:4px; animation:flicker 4s infinite; }
        .subtitle { color:var(--muted); font-size:0.85rem; margin-top:8px; letter-spacing:2px; }
        @keyframes flicker { 0%,95%,100%{opacity:1}96%{opacity:.8}97%{opacity:1}98%{opacity:.6} }

        .upload-section { background:var(--card-bg); border:1px solid var(--border); border-radius:4px; padding:30px; margin-bottom:30px; position:relative; }
        .upload-section::before { content:'[ UPLOAD MODULE ]'; position:absolute; top:-10px; left:20px; background:var(--bg); color:var(--green-dim); font-size:0.7rem; padding:0 8px; letter-spacing:2px; }
        .upload-area { border:2px dashed var(--border); border-radius:4px; padding:40px; text-align:center; cursor:pointer; transition:all 0.3s; }
        .upload-area:hover,.upload-area.drag-over { border-color:var(--green); background:rgba(0,255,65,0.03); box-shadow:inset 0 0 20px rgba(0,255,65,0.05); }
        .upload-icon { font-size:2.5rem; margin-bottom:15px; display:block; }
        .upload-label { color:var(--green-dim); font-size:0.95rem; letter-spacing:1px; }
        .upload-sublabel { color:var(--muted); font-size:0.75rem; margin-top:6px; }
        #fileInput { display:none; }
        .file-selected { margin-top:15px; color:var(--green); font-size:0.85rem; display:none; }

        .btn-analyze { display:block; width:100%; margin-top:20px; padding:14px; background:transparent; border:2px solid var(--green); color:var(--green); font-family:'Orbitron',monospace; font-size:1rem; font-weight:700; letter-spacing:4px; cursor:pointer; border-radius:4px; transition:all 0.3s; position:relative; overflow:hidden; }
        .btn-analyze::before { content:''; position:absolute; left:-100%; top:0; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(0,255,65,0.1),transparent); transition:left 0.5s; }
        .btn-analyze:hover::before { left:100%; }
        .btn-analyze:hover { background:rgba(0,255,65,0.08); box-shadow:0 0 20px rgba(0,255,65,0.3); }
        .btn-analyze:disabled { opacity:0.4; cursor:not-allowed; }

        .loading { display:none; padding:30px; text-align:center; color:var(--green-dim); }
        .loading-bar { width:100%; height:3px; background:var(--border); margin:15px 0; border-radius:2px; overflow:hidden; }
        .loading-bar-fill { height:100%; background:var(--green); box-shadow:0 0 10px var(--green); transition:width 0.4s ease; }
        .loading-status { font-size:0.78rem; color:var(--muted); margin-top:8px; min-height:1.4em; letter-spacing:1px; }

        .results-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px; }
        @media(max-width:768px){ .results-grid{grid-template-columns:1fr} }

        .panel { background:var(--card-bg); border:1px solid var(--border); border-radius:4px; padding:20px; position:relative; }
        .panel-label { position:absolute; top:-10px; left:20px; background:var(--bg); color:var(--green-dim); font-size:0.7rem; padding:0 8px; letter-spacing:2px; }
        #resultImage { width:100%; border-radius:2px; border:1px solid var(--border); }

        .summary-header { font-family:'Orbitron',monospace; font-size:0.9rem; color:var(--green); letter-spacing:3px; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid var(--border); }
        .stats-row { display:flex; justify-content:space-between; margin-bottom:15px; }
        .stat-box { background:var(--green-dark); border:1px solid var(--border); border-radius:4px; padding:10px 15px; text-align:center; flex:1; margin:0 5px; }
        .stat-box:first-child{margin-left:0}.stat-box:last-child{margin-right:0}
        .stat-value { font-family:'Orbitron',monospace; font-size:1.4rem; color:var(--green); font-weight:700; }
        .stat-label { font-size:0.65rem; color:var(--muted); letter-spacing:1px; margin-top:4px; }
        .detections-title { font-family:'Orbitron',monospace; font-size:0.85rem; color:var(--green-dim); letter-spacing:2px; margin:20px 0 15px; }

        .plate-card { background:#050f05; border:1px solid var(--border); border-radius:4px; padding:15px; margin-bottom:12px; display:grid; grid-template-columns:100px 1fr; gap:15px; align-items:center; transition:border-color 0.2s; animation:card-in 0.4s ease forwards; opacity:0; }
        @keyframes card-in { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .plate-card:hover { border-color:var(--green-dim); }
        .plate-snap { width:100px; height:65px; object-fit:cover; border-radius:2px; border:1px solid var(--border); }
        .plate-snap-placeholder { width:100px; height:65px; background:var(--green-dark); border:1px solid var(--border); border-radius:2px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:1.2rem; }

        .plate-number-display { font-family:'Orbitron',monospace; font-size:1.1rem; font-weight:700; color:var(--green); letter-spacing:3px; text-shadow:0 0 10px rgba(0,255,65,0.3); margin-bottom:4px; min-height:1.5em; }
        .ocr-scanning { font-size:0.72rem; color:var(--muted); letter-spacing:1px; animation:blink 1s infinite; }
        @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }

        .plate-format-badge { display:inline-block; background:var(--green-dark); border:1px solid var(--border); color:var(--green-dim); font-size:0.65rem; padding:2px 8px; border-radius:2px; letter-spacing:1px; margin-bottom:8px; }
        .plate-meta-grid { display:grid; grid-template-columns:1fr 1fr; gap:4px; }
        .meta-item { font-size:0.72rem; color:var(--muted); }
        .meta-item span { color:var(--text); }
        .conf-bar-wrap { margin-top:6px; }
        .conf-bar-label { font-size:0.65rem; color:var(--muted); margin-bottom:3px; }
        .conf-bar { height:3px; background:var(--border); border-radius:2px; overflow:hidden; }
        .conf-bar-fill { height:100%; background:var(--green); box-shadow:0 0 6px var(--green); }

        .video-detections { grid-column:1/-1; }
        .no-results { text-align:center; color:var(--muted); padding:40px; font-size:0.85rem; }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <canvas id="matrix-bg"></canvas>

    <div class="page-wrapper">
        <a href="/" class="back-link">‚Üê BACK TO DASHBOARD</a>

        <header>
            <h1 class="title">NUMBER PLATE DETECTION</h1>
            <p class="subtitle">[ YOLO DETECTION ¬∑ TESSERACT.JS CLIENT-SIDE OCR ]</p>
        </header>

        <div class="upload-section">
            <div class="upload-area" id="dropZone">
                <span class="upload-icon">üì°</span>
                <div class="upload-label">DROP FILE OR CLICK TO UPLOAD</div>
                <div class="upload-sublabel">Supported: JPG, PNG, WEBP, MP4, AVI</div>
                <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp,.mp4,.avi">
            </div>
            <div class="file-selected" id="fileSelected">‚ñ∂ FILE LOADED: <span id="fileName"></span></div>
            <button class="btn-analyze" id="analyzeBtn" disabled>ANALYZE</button>
        </div>

        <div class="loading" id="loading">
            <div id="loadingTitle">PROCESSING...</div>
            <div class="loading-bar"><div class="loading-bar-fill" id="progressBar" style="width:0%"></div></div>
            <div class="loading-status" id="loadingStatus">Initialising...</div>
        </div>

        <div id="resultsSection" style="display:none;">
            <div class="results-grid" id="resultsGrid"></div>
        </div>
    </div>

    <script>
    // ‚îÄ‚îÄ Matrix rain ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const canvas = document.getElementById('matrix-bg');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const cols = Math.floor(canvas.width / 14), drops = Array(cols).fill(1);
    function drawMatrix() {
        ctx.fillStyle='rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#00ff41'; ctx.font='12px Share Tech Mono';
        drops.forEach((y,i)=>{
            const c=Math.random()>.5?String.fromCharCode(0x30A0+Math.random()*96):Math.floor(Math.random()*10);
            ctx.fillText(c,i*14,y*14);
            if(y*14>canvas.height&&Math.random()>.975)drops[i]=0; drops[i]++;
        });
    }
    setInterval(drawMatrix,50);

    // ‚îÄ‚îÄ Upload UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const dropZone=document.getElementById('dropZone'), fileInput=document.getElementById('fileInput');
    const analyzeBtn=document.getElementById('analyzeBtn');
    let selectedFile=null;

    dropZone.addEventListener('click',()=>fileInput.click());
    dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over');});
    dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('drag-over');if(e.dataTransfer.files[0])setFile(e.dataTransfer.files[0]);});
    fileInput.addEventListener('change',()=>{if(fileInput.files[0])setFile(fileInput.files[0]);});

    function setFile(f){
        selectedFile=f;
        document.getElementById('fileName').textContent=f.name;
        document.getElementById('fileSelected').style.display='block';
        analyzeBtn.disabled=false;
    }

    function setProgress(pct, status){
        document.getElementById('progressBar').style.width=pct+'%';
        document.getElementById('loadingStatus').textContent=status;
    }

    // ‚îÄ‚îÄ Indian plate helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const stateMap={
        'MH':'Maharashtra','DL':'Delhi','KA':'Karnataka','TN':'Tamil Nadu',
        'WB':'West Bengal','GJ':'Gujarat','RJ':'Rajasthan','UP':'Uttar Pradesh',
        'MP':'Madhya Pradesh','AP':'Andhra Pradesh','TS':'Telangana','KL':'Kerala',
        'HR':'Haryana','PB':'Punjab','BR':'Bihar','OR':'Odisha','AS':'Assam',
        'JH':'Jharkhand','UK':'Uttarakhand','HP':'Himachal Pradesh','GA':'Goa',
        'CH':'Chandigarh','JK':'Jammu & Kashmir','MN':'Manipur','ML':'Meghalaya',
        'MZ':'Mizoram','NL':'Nagaland','SK':'Sikkim','TR':'Tripura','AR':'Arunachal Pradesh',
    };

    function parseIndianPlate(text){
        const c=text.replace(/\s+/g,'').toUpperCase();
        const m=c.match(/^([A-Z]{2})(\d{2})([A-Z]{1,3})(\d{4})$/);
        if(m) return{valid:true,state:m[1],district:m[2],series:m[3],number:m[4],formatted:`${m[1]} ${m[2]} ${m[3]} ${m[4]}`};
        return{valid:false,formatted:c||text};
    }

    // ‚îÄ‚îÄ Tesseract.js worker (created once, reused) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let tWorker=null;
    async function getWorker(){
        if(!tWorker){
            setProgress(15,'Loading OCR engine (Tesseract.js)...');
            tWorker=await Tesseract.createWorker('eng',1,{logger:()=>{}});
            await tWorker.setParameters({
                tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
                tessedit_pageseg_mode:'7',   // single text line
            });
        }
        return tWorker;
    }

    async function ocrPlate(b64){
        try{
            const w=await getWorker();
            const{data:{text}}=await w.recognize('data:image/jpeg;base64,'+b64);
            const raw=text.replace(/[^A-Z0-9]/g,'').toUpperCase().trim();
            const m=raw.match(/([A-Z]{2}\d{2}[A-Z]{1,3}\d{4})/);
            return m?m[1]:(raw||'UNREADABLE');
        }catch{return 'UNREADABLE';}
    }

    // ‚îÄ‚îÄ Analyse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    analyzeBtn.addEventListener('click', async()=>{
        if(!selectedFile) return;
        document.getElementById('loading').style.display='block';
        document.getElementById('resultsSection').style.display='none';
        analyzeBtn.disabled=true;
        setProgress(5,'Uploading to server...');

        const fd=new FormData(); fd.append('file',selectedFile);
        let data;
        try{
            const res=await fetch('/plates/process',{method:'POST',body:fd});
            data=await res.json();
        }catch(err){
            document.getElementById('loading').style.display='none';
            analyzeBtn.disabled=false;
            alert('Server error: '+err.message); return;
        }

        if(data.error){
            document.getElementById('loading').style.display='none';
            analyzeBtn.disabled=false;
            alert('Error: '+data.error); return;
        }

        setProgress(35,`Server found ${data.detections.length} plate region(s). Starting OCR...`);

        // Render cards immediately (with scanning placeholder), then fill in text as OCR finishes
        renderResults(data, true);
        document.getElementById('loading').style.display='none';
        document.getElementById('resultsSection').style.display='block';
        analyzeBtn.disabled=false;

        // OCR each plate and update cards live
        for(let i=0;i<data.detections.length;i++){
            const d=data.detections[i];
            const cardEl=document.getElementById(`plate-card-${i}`);
            if(!d.plate_crop){ updateCard(cardEl,'UNREADABLE'); continue; }
            const text=await ocrPlate(d.plate_crop);
            d.plate_text=text;
            updateCard(cardEl, text);
        }
    });

    function updateCard(cardEl, text){
        if(!cardEl) return;
        const parsed=parseIndianPlate(text);
        const state=parsed.valid&&stateMap[parsed.state]?stateMap[parsed.state]:null;
        cardEl.querySelector('.plate-number-display').textContent=parsed.formatted;
        cardEl.querySelector('.plate-format-badge').textContent=parsed.valid?'‚úì VALID IND FORMAT':'‚ö† UNVERIFIED FORMAT';
        const meta=cardEl.querySelector('.plate-meta-grid');
        meta.innerHTML=`
            ${parsed.valid?`<div class="meta-item">DISTRICT: <span>${parsed.district}</span></div>`:''}
            ${parsed.valid?`<div class="meta-item">SERIES: <span>${parsed.series}</span></div>`:''}
            ${state?`<div class="meta-item">STATE: <span>${state}</span></div>`:''}
            ${cardEl.dataset.frame?`<div class="meta-item">FRAME: <span>${cardEl.dataset.frame}</span></div>`:''}
        `;
    }

    // ‚îÄ‚îÄ Render (initial pass with placeholders) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderResults(data, withPlaceholders=false){
        const grid=document.getElementById('resultsGrid');
        grid.innerHTML='';
        const total=data.detections.length;

        if(data.type==='image'){
            const imgPanel=document.createElement('div');
            imgPanel.className='panel';
            imgPanel.innerHTML=`<span class="panel-label">[ ANNOTATED OUTPUT ]</span><img id="resultImage" src="data:image/jpeg;base64,${data.image}" alt="Result">`;
            grid.appendChild(imgPanel);

            const infoPanel=document.createElement('div');
            infoPanel.className='panel';
            infoPanel.innerHTML=`
                <span class="panel-label">[ DETECTION SUMMARY ]</span>
                <div class="summary-header">SCAN RESULTS</div>
                <div class="stats-row">
                    <div class="stat-box"><div class="stat-value">${total}</div><div class="stat-label">PLATES FOUND</div></div>
                    <div class="stat-box"><div class="stat-value" id="validCount">‚Äî</div><div class="stat-label">VALID FORMAT</div></div>
                </div>
                <div class="detections-title">DETAILED DETECTIONS</div>
                <div id="plateList">${total===0?'<div class="no-results">NO PLATES DETECTED</div>':''}</div>
            `;
            grid.appendChild(infoPanel);
            data.detections.forEach((d,i)=>appendCard(d,i,infoPanel.querySelector('#plateList')));

        } else {
            const panel=document.createElement('div');
            panel.className='panel video-detections';
            panel.innerHTML=`
                <span class="panel-label">[ VIDEO SCAN RESULTS ]</span>
                <div class="summary-header">PLATES IDENTIFIED IN VIDEO</div>
                <div class="stats-row">
                    <div class="stat-box"><div class="stat-value">${total}</div><div class="stat-label">UNIQUE PLATES</div></div>
                    <div class="stat-box"><div class="stat-value" id="validCount">‚Äî</div><div class="stat-label">VALID FORMAT</div></div>
                </div>
                <div class="detections-title">ALL DETECTED VEHICLES</div>
                <div id="videoList">${total===0?'<div class="no-results">NO PLATES DETECTED IN VIDEO</div>':''}</div>
            `;
            grid.appendChild(panel);
            data.detections.forEach((d,i)=>appendCard(d,i,panel.querySelector('#videoList')));
        }
    }

    function appendCard(d, index, container){
        const confPct=Math.round(d.confidence*100);
        const card=document.createElement('div');
        card.className='plate-card';
        card.id=`plate-card-${index}`;
        card.dataset.frame=d.frame||'';
        card.style.animationDelay=`${index*0.07}s`;

        card.innerHTML=`
            ${d.snapshot?`<img class="plate-snap" src="data:image/jpeg;base64,${d.snapshot}" alt="Vehicle">`:`<div class="plate-snap-placeholder">üöó</div>`}
            <div class="plate-info">
                <div class="plate-number-display"><span class="ocr-scanning">SCANNING...</span></div>
                <div class="plate-format-badge">‚è≥ READING PLATE</div>
                <div class="plate-meta-grid"></div>
                <div class="conf-bar-wrap">
                    <div class="conf-bar-label">DETECTION CONFIDENCE: ${confPct}%</div>
                    <div class="conf-bar"><div class="conf-bar-fill" style="width:${confPct}%"></div></div>
                </div>
            </div>
        `;
        container.appendChild(card);
    }
    </script>
</body>
</html>